<!DOCTYPE html>
<html>
<head>
 <title>Creating Ubuntu and Debian root filesystems</title>
 <meta charset="utf-8">
 <link rel="stylesheet" type="text/css" href="common.css">
</head>
<body>
<script>
var title = "Creating base images"
</script>

 <textarea id="source">
background-size: contain
background-image: url(titlecard-lca2019.png)

---
class: center, middle

.chapterhead[
# Creating Debian and Ubuntu container base images
# The old and simple way
Sysadmin Miniconf Linux.Conf.Au 2019 Christchurch
]
.footnote[Hamish Coleman - hamish@zot.org]

???
- Your notes here

---
# What is a base image?

- A root filesystem

- Or a template for one

- eg: Docker, Kubernetes and LXC all will use base image templates

???
- Pretty much all operating systems have a root filesystem
- It is the one place that the system expects to exist so it can boot up
- All other kinds of Thin VMs - Containers - are no different
- The same for Thick VMs - Full System emulators - they have this root
filesystem packed into their disk image

--
- Not used for "single binary image" containers

???
- There are some container building efforts that build "single binary images"
    - This talk is not touching on those

--

<br>

# Where do *your* base images come from?

- Provided by your Operating System

- Downloaded by your framework

--
- "Steve", around the back of the pub?

---
# Why build your own?

- The three "R"s:
    - Repeatable
    - Reliable
    - Reproducible

- Customise the default config to match your needs

- Include special packages (private builds or specific versions)

- Use one build that can be used for Testing, QA, CI and Production

- Building for new architectures or hardware platforms

???
- If you are using services provided by others, it is often important to have
both trust in them and a plan for when they stop
- Building your own image gives you the ability to prove that you can control
your software and work independantly of external changes.
- It can also be important if you are incorporating your own local software
as that software will not be part of any third party image
- Finally, it is sometimes required if you are building for a new machine or
architecture that nobody else supports.

---
# What options do I have?


- debootstrap
    - Used by the Ubuntu and Debian installers, implements all the
    package installation internally, so only needs shell, wget and
    binutils to run

- cdebootstrap
    - A "C implementation of debootstrap", with the same features

- multistrap
    - Uses the normal debian apt and dpkg tools.  Supports installing the
    base system with packages from multiple repositories

- vmdebootstrap
    - Wrapper around debootstrap for building a virtual disk image for VMs

- Many more!

???
- debootstrap can be used to install Debian from a completely different OS,
without installing anything other than the debootstrap shell script
- These four are all easily installable from the Debian and Ubuntu package
repositories
- There are other packaged options, and even more that are just someones
project
- I will go into more detail about two of these:
    - debootstrap since it is the lowest common denominator
    - multistrap because it is is useful for foreign architecture or
    multi-repository cases

---
# debootstrap

<p style="line-height: 99%;"><br></p>
<pre class="example">
sudo debootstrap --arch=amd64 \
    SUITE \
    TARGETDIR \
    MIRROR
</pre>

???
- Foreign architecture needs a second stage (--foreign and --second-stage)
- It is possible to avoid requiring root for much of the build, but that
has its own complications (fakeroot permissions preservation, foreign arch emu)

--

SUITE is one of the Debian/Ubuntu release code names:
- jessie, trusty, stretch, xenial, bionic, buster, etc

MIRROR is the package repository URL:
- http://httpredir.debian.org/debian
- http://archive.ubuntu.com/ubuntu

---
# debootstrap

<div class="exampleref">
    (See also the [example1](example1) files in the repo)
</div>
<pre class="example">
sudo debootstrap --arch=amd64 \
    stretch \
    /var/lib/container/example1 \
    http://httpredir.debian.org/debian
</pre>

???
- This will take some time
- There are ways to cache the downloads and speed it up
- The codenames for both debian and ubuntu are valid here, however a newer
debootstrap might sometimes be needed (or a workaround)
- Ubuntu would obviously have a different archive URL

---
# multistrap

<pre class="example">
sudo /usr/sbin/multistrap --arch amd64 \
    -f multistrap.conf \
    -d TARGETDIR
</pre>

???
- stateless - can pickup where it left off
- Harder to avoid running as root (fakeroot doesnt work as well here)
- needs a postinstall script to properly complete installation
- policy.d to avoid packages starting (multistrap runs the "real" package
post install scripts
- Foreign architecture is still fun

--
<br><br>
*NOTE:* it needs a config file!

---
# multistrap

Config file ([multistrap.conf](example2/multistrap.conf))
<pre class="example">
[General]
bootstrap=NameOfSectionDefiningRepo
aptsources=NameOfSectionDefiningRepo

[NameOfSectionDefiningRepo]
source=MIRROR
suite=SUITE
keyring=debian-archive-keyring ubuntu-archive-keyring
packages= systemd udev kmod apt
</pre>

???
- Some lines left out for berevity - see the example2 folder in the repo for
a complete set
- keyring defines a package name that needs to be installed on the host build
system to allow the correct authentication of packages installed in the target

---
# multistrap

<div class="exampleref">
    (See also the [example2](example2) files in the repo)
</div>
Install stage:
<pre class="example">
sudo /usr/sbin/multistrap --arch amd64 \
    -f multistrap.conf \
    -d /var/lib/container/example2
</pre>
<br>
Configure stage: (sometimes optional)
<pre class="example">
chroot /var/lib/container/example2 dpkg --configure -a
</pre>

???
- Installation does everything it can, up until it needs to run the install
scripts
- Configure is needed for foreign architectures, or more complex native ones
- For clarity, the configure step has been significantly shortened.  See the
example files (or just read the multistrap man page) for more details

---
# Compare the two tools:

|                                          | debootstrap | multistrap |
|------------------------------------------|:-----------:|:----------:|
| Used by the distro installer             | <p>&#x2714;</p> | |
| Can install from multiple package repos  |             | <p>&#x2714;</p> |
| Has a Config file                        |             | <p>&#x2714;</p> |
| Runs the normal post install scripts     |             | <p>&#x2714;</p> |
| Can install without runing binaries for the target architecture | <p>&#x2714;</p> | &nbsp; |

???
- I use debootstrap for anything simple - especially oneliners
- While debootstrap can be customised to do complex installs, I prefer the
ability to use the multistrap config file
- The config file also allows annotations and git commits to be clear


---
# Output

- what you can use it for straight away

---
# Improvements

- fixup
- minimise
- customise

---
# Simple boot

---
# Other ways to boot

- chroot
- nspawn
- libvirt
- packing for qemu
- uefi

---
# other useful projects

- guestfish

---

<div class="center middle"><h1>Questions?</h1></div>
<br><br><br><br>

<div class="center middle"><h1>Example files are in the repository</h1></div>


- github project:
  - https://github.com/hamishcoleman/talk-containers1/
- talk slides:
  - https://hamishcoleman.github.io/talk-containers1/slides.html

<br><br>
<div class="right">Hamish Coleman - hamish@zot.org</div>
???
- Finish it all up with a page of links

<!-- End slides. -->

 </textarea>
 <script src="remark-latest.min.js"> </script>
 <script src="common-slidenr.js"> </script>
 <script>
  var slideshow = remark.create({
    ratio: '16:9',
    slideNumberFormat: slidenr,
    countIncrementalSlides: false,
  });
 </script>
</body>
</html>

